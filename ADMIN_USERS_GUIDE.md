# 📚 دليل استخدام نظام إدارة المستخدمين
## User Management System Guide

---

## ✅ تم إنشاؤه

### **الصفحات:**
1. ✅ `/admin/users` - صفحة إدارة المستخدمين
2. ✅ `/admin/add-user` - صفحة إضافة مستخدم جديد

### **الملفات:**
- ✅ `src/pages/AdminUsers.tsx` - إدارة كاملة للمستخدمين
- ✅ `src/pages/AdminAddUser.tsx` - نموذج إضافة مستخدم
- ✅ `ADMIN_USER_CREATION_FUNCTIONS.sql` - دوال SQL مساعدة

---

## 🚀 الوصول للنظام

### **الرابط:**
```
http://localhost:8081/admin/users
```

### **المتطلبات:**
- يجب أن تكون مسجل دخول
- يجب أن تكون مدير (role = 'admin')

---

## 📋 المميزات

### **1. صفحة إدارة المستخدمين** `/admin/users`

#### **البحث والفلترة:**
- ✅ البحث بالبريد الإلكتروني
- ✅ البحث بالاسم
- ✅ فلترة حسب الدور (admin/office/agent/publisher)
- ✅ فلترة حسب الحالة (نشط/محظور/موثق)

#### **عرض البيانات:**
- البريد الإلكتروني
- الاسم الكامل
- الدور الحالي (قابل للتعديل)
- عدد العقارات / الحد الأقصى
- الحالة (نشط/محظور/موثق)
- آخر دخول

#### **الإجراءات:**
- ✅ **تغيير الدور** - من قائمة منسدلة مباشرة
- ✅ **حظر/إلغاء حظر** - بنقرة واحدة مع تأكيد
- ✅ **عرض الإحصائيات** - في الترويسة

---

### **2. صفحة إضافة مستخدم** `/admin/add-user`

#### **معلومات تسجيل الدخول (مطلوبة):**
- ✅ البريد الإلكتروني
- ✅ كلمة المرور (6 أحرف على الأقل)

#### **المعلومات الشخصية (اختيارية):**
- الاسم الكامل
- رقم الهاتف
- العنوان

#### **الدور والصلاحيات:**
- **👤 ناشر عادي (Publisher):**
  - 3 عقارات
  - 10 صور لكل عقار
  - 0 عقار مميز
  - 100 MB تخزين

- **🏆 وكيل عقاري موثق (Agent):**
  - 10 عقارات
  - 10 صور لكل عقار
  - 3 عقارات مميزة
  - 500 MB تخزين

- **🏢 مكتب عقارات (Office):**
  - ∞ عقارات غير محدودة
  - 10 صور لكل عقار
  - 50 عقار مميز
  - 5000 MB تخزين

- **🔑 مدير النظام (Admin):**
  - ∞ كل شيء غير محدود

#### **معاينة الصلاحيات:**
- عرض تلقائي للحدود عند اختيار الدور

---

## 🔧 كيفية الاستخدام

### **إضافة مستخدم جديد:**

1. **اذهب إلى:**
   ```
   /admin/users
   ```

2. **اضغط "إضافة مستخدم جديد"**

3. **أدخل البيانات:**
   - البريد الإلكتروني (مطلوب)
   - كلمة المرور (مطلوب، 6+ أحرف)
   - الاسم (اختياري)
   - الهاتف (اختياري)
   - العنوان (اختياري)
   - **اختر الدور** (افتراضياً: ناشر عادي)

4. **راجع الصلاحيات:**
   - ستظهر بطاقة تعرض الحدود المختارة

5. **اضغط "إنشاء المستخدم"**

6. **النتيجة:**
   - ✅ تم إنشاء المستخدم في `auth.users`
   - ✅ تم إنشاء الملف الشخصي في `profiles`
   - ✅ تم تعيين الصلاحيات في `user_permissions`
   - ✅ البريد الإلكتروني مؤكد تلقائياً
   - ✅ الحالة: نشط
   - ✅ موثق تلقائياً (ما عدا الناشر العادي)

---

### **تغيير دور مستخدم:**

1. في جدول المستخدمين
2. ابحث عن المستخدم
3. اضغط على القائمة المنسدلة في عمود "الدور"
4. اختر الدور الجديد
5. ✅ يتم التحديث فوراً

**ملاحظة:** الحدود تتحدث تلقائياً حسب الدور الجديد

---

### **حظر/إلغاء حظر مستخدم:**

1. ابحث عن المستخدم
2. اضغط زر الحظر (🚫) أو الإلغاء (✅)
3. أكد العملية
4. ✅ يتم التطبيق فوراً

**النتيجة:**
- محظور: `can_publish = false`, `is_active = false`
- لا يستطيع نشر أو تعديل عقارات

---

## 📊 الإحصائيات

في أعلى الصفحة ستجد:
```
إجمالي المستخدمين: X | المعروضين: Y
```

---

## ⚠️ ملاحظات مهمة

### **1. صلاحيات Service Role:**
- إنشاء المستخدم يستخدم `supabase.auth.admin.createUser()`
- يتطلب **Service Role Key** (ليس Anon Key)
- ⚠️ **لا تكشف Service Role Key في Frontend**

### **2. الحل الحالي:**
في كود `AdminAddUser.tsx`، يستخدم:
```typescript
const { data, error } = await supabase.auth.admin.createUser({
  email: formData.email,
  password: formData.password,
  email_confirm: true,
});
```

**هذا يعمل فقط إذا:**
- كنت تستخدم Supabase Service Role Key
- أو لديك Edge Function تقوم بالإنشاء

### **3. للإنتاج (Production):**

#### **الخيار 1: Edge Function** (موصى به)
```typescript
// في Supabase Edge Function
Deno.serve(async (req) => {
  const { email, password, userData } = await req.json();
  
  const { data, error } = await supabaseAdmin.auth.admin.createUser({
    email,
    password,
    email_confirm: true,
  });
  
  if (data.user) {
    await supabaseAdmin.rpc('setup_new_user', {
      p_user_id: data.user.id,
      p_email: email,
      ...userData
    });
  }
  
  return new Response(JSON.stringify({ success: true }));
});
```

#### **الخيار 2: Backend API**
- إنشاء API endpoint في Backend
- استخدام Service Role Key هناك
- Frontend يستدعي الـ API

#### **الخيار 3: دعوة المستخدمين**
- إرسال دعوة للمستخدم للتسجيل
- المدير يرقي المستخدم بعد التسجيل

---

## 🔐 الأمان

### **RLS Policies المطبقة:**

1. **قراءة الصلاحيات:**
   - المستخدم يرى صلاحياته فقط
   - المدراء يرون جميع الصلاحيات

2. **تحديث الصلاحيات:**
   - المدراء فقط

3. **إضافة صلاحيات:**
   - المدراء فقط
   - أو Triggers التلقائية

---

## 🐛 استكشاف الأخطاء

### **"Only admins can update user roles"**
- أنت لست مدير
- تحقق من دورك: `SELECT role FROM user_permissions WHERE user_id = auth.uid()`

### **"User not found"**
- المستخدم غير موجود في `auth.users`
- تحقق من البريد الإلكتروني

### **"Email already exists"**
- البريد مستخدم بالفعل
- استخدم بريد آخر

---

## 📝 TODO للتحسينات المستقبلية

- [ ] إضافة رفع صور ملف شخصي
- [ ] إضافة تصدير بيانات المستخدمين (Excel/CSV)
- [ ] إضافة حذف مستخدم (مع تأكيد مزدوج)
- [ ] إضافة إحصائيات مفصلة لكل مستخدم
- [ ] إضافة سجل الأنشطة (Audit Log)
- [ ] إضافة إرسال بريد إلكتروني ترحيبي
- [ ] إضافة إعادة تعيين كلمة مرور
- [ ] إضافة رؤية العقارات الخاصة بكل مستخدم

---

## ✅ الاختبار

### **خطوات الاختبار:**

1. **تسجيل دخول كمدير**
2. **اذهب لـ `/admin/users`**
3. **جرب إضافة مستخدم جديد:**
   ```
   Email: test@example.com
   Password: test123
   Role: agent
   ```
4. **تحقق من الإنشاء:**
   ```sql
   SELECT * FROM users_with_permissions WHERE email = 'test@example.com';
   ```
5. **جرب تغيير الدور**
6. **جرب الحظر**
7. **جرب الفلاتر**

---

## 🎉 انتهى!

النظام جاهز للاستخدام! 🚀
