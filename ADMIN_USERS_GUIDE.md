# ๐ ุฏููู ุงุณุชุฎุฏุงู ูุธุงู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
## User Management System Guide

---

## โ ุชู ุฅูุดุงุคู

### **ุงูุตูุญุงุช:**
1. โ `/admin/users` - ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
2. โ `/admin/add-user` - ุตูุญุฉ ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ

### **ุงููููุงุช:**
- โ `src/pages/AdminUsers.tsx` - ุฅุฏุงุฑุฉ ูุงููุฉ ูููุณุชุฎุฏููู
- โ `src/pages/AdminAddUser.tsx` - ูููุฐุฌ ุฅุถุงูุฉ ูุณุชุฎุฏู
- โ `ADMIN_USER_CREATION_FUNCTIONS.sql` - ุฏูุงู SQL ูุณุงุนุฏุฉ

---

## ๐ ุงููุตูู ูููุธุงู

### **ุงูุฑุงุจุท:**
```
http://localhost:8081/admin/users
```

### **ุงููุชุทูุจุงุช:**
- ูุฌุจ ุฃู ุชููู ูุณุฌู ุฏุฎูู
- ูุฌุจ ุฃู ุชููู ูุฏูุฑ (role = 'admin')

---

## ๐ ุงููููุฒุงุช

### **1. ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู** `/admin/users`

#### **ุงูุจุญุซ ูุงูููุชุฑุฉ:**
- โ ุงูุจุญุซ ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- โ ุงูุจุญุซ ุจุงูุงุณู
- โ ููุชุฑุฉ ุญุณุจ ุงูุฏูุฑ (admin/office/agent/publisher)
- โ ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ (ูุดุท/ูุญุธูุฑ/ููุซู)

#### **ุนุฑุถ ุงูุจูุงูุงุช:**
- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- ุงูุงุณู ุงููุงูู
- ุงูุฏูุฑ ุงูุญุงูู (ูุงุจู ููุชุนุฏูู)
- ุนุฏุฏ ุงูุนูุงุฑุงุช / ุงูุญุฏ ุงูุฃูุตู
- ุงูุญุงูุฉ (ูุดุท/ูุญุธูุฑ/ููุซู)
- ุขุฎุฑ ุฏุฎูู

#### **ุงูุฅุฌุฑุงุกุงุช:**
- โ **ุชุบููุฑ ุงูุฏูุฑ** - ูู ูุงุฆูุฉ ููุณุฏูุฉ ูุจุงุดุฑุฉ
- โ **ุญุธุฑ/ุฅูุบุงุก ุญุธุฑ** - ุจููุฑุฉ ูุงุญุฏุฉ ูุน ุชุฃููุฏ
- โ **ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช** - ูู ุงูุชุฑููุณุฉ

---

### **2. ุตูุญุฉ ุฅุถุงูุฉ ูุณุชุฎุฏู** `/admin/add-user`

#### **ูุนูููุงุช ุชุณุฌูู ุงูุฏุฎูู (ูุทููุจุฉ):**
- โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- โ ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)

#### **ุงููุนูููุงุช ุงูุดุฎุตูุฉ (ุงุฎุชูุงุฑูุฉ):**
- ุงูุงุณู ุงููุงูู
- ุฑูู ุงููุงุชู
- ุงูุนููุงู

#### **ุงูุฏูุฑ ูุงูุตูุงุญูุงุช:**
- **๐ค ูุงุดุฑ ุนุงุฏู (Publisher):**
  - 3 ุนูุงุฑุงุช
  - 10 ุตูุฑ ููู ุนูุงุฑ
  - 0 ุนูุงุฑ ูููุฒ
  - 100 MB ุชุฎุฒูู

- **๐ ูููู ุนูุงุฑู ููุซู (Agent):**
  - 10 ุนูุงุฑุงุช
  - 10 ุตูุฑ ููู ุนูุงุฑ
  - 3 ุนูุงุฑุงุช ูููุฒุฉ
  - 500 MB ุชุฎุฒูู

- **๐ข ููุชุจ ุนูุงุฑุงุช (Office):**
  - โ ุนูุงุฑุงุช ุบูุฑ ูุญุฏูุฏุฉ
  - 10 ุตูุฑ ููู ุนูุงุฑ
  - 50 ุนูุงุฑ ูููุฒ
  - 5000 MB ุชุฎุฒูู

- **๐ ูุฏูุฑ ุงููุธุงู (Admin):**
  - โ ูู ุดูุก ุบูุฑ ูุญุฏูุฏ

#### **ูุนุงููุฉ ุงูุตูุงุญูุงุช:**
- ุนุฑุถ ุชููุงุฆู ููุญุฏูุฏ ุนูุฏ ุงุฎุชูุงุฑ ุงูุฏูุฑ

---

## ๐ง ููููุฉ ุงูุงุณุชุฎุฏุงู

### **ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ:**

1. **ุงุฐูุจ ุฅูู:**
   ```
   /admin/users
   ```

2. **ุงุถุบุท "ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ"**

3. **ุฃุฏุฎู ุงูุจูุงูุงุช:**
   - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูุทููุจ)
   - ูููุฉ ุงููุฑูุฑ (ูุทููุจุ 6+ ุฃุญุฑู)
   - ุงูุงุณู (ุงุฎุชูุงุฑู)
   - ุงููุงุชู (ุงุฎุชูุงุฑู)
   - ุงูุนููุงู (ุงุฎุชูุงุฑู)
   - **ุงุฎุชุฑ ุงูุฏูุฑ** (ุงูุชุฑุงุถูุงู: ูุงุดุฑ ุนุงุฏู)

4. **ุฑุงุฌุน ุงูุตูุงุญูุงุช:**
   - ุณุชุธูุฑ ุจุทุงูุฉ ุชุนุฑุถ ุงูุญุฏูุฏ ุงููุฎุชุงุฑุฉ

5. **ุงุถุบุท "ุฅูุดุงุก ุงููุณุชุฎุฏู"**

6. **ุงููุชูุฌุฉ:**
   - โ ุชู ุฅูุดุงุก ุงููุณุชุฎุฏู ูู `auth.users`
   - โ ุชู ุฅูุดุงุก ุงูููู ุงูุดุฎุตู ูู `profiles`
   - โ ุชู ุชุนููู ุงูุตูุงุญูุงุช ูู `user_permissions`
   - โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุคูุฏ ุชููุงุฆูุงู
   - โ ุงูุญุงูุฉ: ูุดุท
   - โ ููุซู ุชููุงุฆูุงู (ูุง ุนุฏุง ุงููุงุดุฑ ุงูุนุงุฏู)

---

### **ุชุบููุฑ ุฏูุฑ ูุณุชุฎุฏู:**

1. ูู ุฌุฏูู ุงููุณุชุฎุฏููู
2. ุงุจุญุซ ุนู ุงููุณุชุฎุฏู
3. ุงุถุบุท ุนูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูู ุนููุฏ "ุงูุฏูุฑ"
4. ุงุฎุชุฑ ุงูุฏูุฑ ุงูุฌุฏูุฏ
5. โ ูุชู ุงูุชุญุฏูุซ ููุฑุงู

**ููุงุญุธุฉ:** ุงูุญุฏูุฏ ุชุชุญุฏุซ ุชููุงุฆูุงู ุญุณุจ ุงูุฏูุฑ ุงูุฌุฏูุฏ

---

### **ุญุธุฑ/ุฅูุบุงุก ุญุธุฑ ูุณุชุฎุฏู:**

1. ุงุจุญุซ ุนู ุงููุณุชุฎุฏู
2. ุงุถุบุท ุฒุฑ ุงูุญุธุฑ (๐ซ) ุฃู ุงูุฅูุบุงุก (โ)
3. ุฃูุฏ ุงูุนูููุฉ
4. โ ูุชู ุงูุชุทุจูู ููุฑุงู

**ุงููุชูุฌุฉ:**
- ูุญุธูุฑ: `can_publish = false`, `is_active = false`
- ูุง ูุณุชุทูุน ูุดุฑ ุฃู ุชุนุฏูู ุนูุงุฑุงุช

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

ูู ุฃุนูู ุงูุตูุญุฉ ุณุชุฌุฏ:
```
ุฅุฌูุงูู ุงููุณุชุฎุฏููู: X | ุงููุนุฑูุถูู: Y
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### **1. ุตูุงุญูุงุช Service Role:**
- ุฅูุดุงุก ุงููุณุชุฎุฏู ูุณุชุฎุฏู `supabase.auth.admin.createUser()`
- ูุชุทูุจ **Service Role Key** (ููุณ Anon Key)
- โ๏ธ **ูุง ุชูุดู Service Role Key ูู Frontend**

### **2. ุงูุญู ุงูุญุงูู:**
ูู ููุฏ `AdminAddUser.tsx`ุ ูุณุชุฎุฏู:
```typescript
const { data, error } = await supabase.auth.admin.createUser({
  email: formData.email,
  password: formData.password,
  email_confirm: true,
});
```

**ูุฐุง ูุนูู ููุท ุฅุฐุง:**
- ููุช ุชุณุชุฎุฏู Supabase Service Role Key
- ุฃู ูุฏูู Edge Function ุชููู ุจุงูุฅูุดุงุก

### **3. ููุฅูุชุงุฌ (Production):**

#### **ุงูุฎูุงุฑ 1: Edge Function** (ููุตู ุจู)
```typescript
// ูู Supabase Edge Function
Deno.serve(async (req) => {
  const { email, password, userData } = await req.json();
  
  const { data, error } = await supabaseAdmin.auth.admin.createUser({
    email,
    password,
    email_confirm: true,
  });
  
  if (data.user) {
    await supabaseAdmin.rpc('setup_new_user', {
      p_user_id: data.user.id,
      p_email: email,
      ...userData
    });
  }
  
  return new Response(JSON.stringify({ success: true }));
});
```

#### **ุงูุฎูุงุฑ 2: Backend API**
- ุฅูุดุงุก API endpoint ูู Backend
- ุงุณุชุฎุฏุงู Service Role Key ููุงู
- Frontend ูุณุชุฏุนู ุงูู API

#### **ุงูุฎูุงุฑ 3: ุฏุนูุฉ ุงููุณุชุฎุฏููู**
- ุฅุฑุณุงู ุฏุนูุฉ ูููุณุชุฎุฏู ููุชุณุฌูู
- ุงููุฏูุฑ ูุฑูู ุงููุณุชุฎุฏู ุจุนุฏ ุงูุชุณุฌูู

---

## ๐ ุงูุฃูุงู

### **RLS Policies ุงููุทุจูุฉ:**

1. **ูุฑุงุกุฉ ุงูุตูุงุญูุงุช:**
   - ุงููุณุชุฎุฏู ูุฑู ุตูุงุญูุงุชู ููุท
   - ุงููุฏุฑุงุก ูุฑูู ุฌููุน ุงูุตูุงุญูุงุช

2. **ุชุญุฏูุซ ุงูุตูุงุญูุงุช:**
   - ุงููุฏุฑุงุก ููุท

3. **ุฅุถุงูุฉ ุตูุงุญูุงุช:**
   - ุงููุฏุฑุงุก ููุท
   - ุฃู Triggers ุงูุชููุงุฆูุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **"Only admins can update user roles"**
- ุฃูุช ูุณุช ูุฏูุฑ
- ุชุญูู ูู ุฏูุฑู: `SELECT role FROM user_permissions WHERE user_id = auth.uid()`

### **"User not found"**
- ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู `auth.users`
- ุชุญูู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู

### **"Email already exists"**
- ุงูุจุฑูุฏ ูุณุชุฎุฏู ุจุงููุนู
- ุงุณุชุฎุฏู ุจุฑูุฏ ุขุฎุฑ

---

## ๐ TODO ููุชุญุณููุงุช ุงููุณุชูุจููุฉ

- [ ] ุฅุถุงูุฉ ุฑูุน ุตูุฑ ููู ุดุฎุตู
- [ ] ุฅุถุงูุฉ ุชุตุฏูุฑ ุจูุงูุงุช ุงููุณุชุฎุฏููู (Excel/CSV)
- [ ] ุฅุถุงูุฉ ุญุฐู ูุณุชุฎุฏู (ูุน ุชุฃููุฏ ูุฒุฏูุฌ)
- [ ] ุฅุถุงูุฉ ุฅุญุตุงุฆูุงุช ููุตูุฉ ููู ูุณุชุฎุฏู
- [ ] ุฅุถุงูุฉ ุณุฌู ุงูุฃูุดุทุฉ (Audit Log)
- [ ] ุฅุถุงูุฉ ุฅุฑุณุงู ุจุฑูุฏ ุฅููุชุฑููู ุชุฑุญูุจู
- [ ] ุฅุถุงูุฉ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ูุฑูุฑ
- [ ] ุฅุถุงูุฉ ุฑุคูุฉ ุงูุนูุงุฑุงุช ุงูุฎุงุตุฉ ุจูู ูุณุชุฎุฏู

---

## โ ุงูุงุฎุชุจุงุฑ

### **ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:**

1. **ุชุณุฌูู ุฏุฎูู ููุฏูุฑ**
2. **ุงุฐูุจ ูู `/admin/users`**
3. **ุฌุฑุจ ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ:**
   ```
   Email: test@example.com
   Password: test123
   Role: agent
   ```
4. **ุชุญูู ูู ุงูุฅูุดุงุก:**
   ```sql
   SELECT * FROM users_with_permissions WHERE email = 'test@example.com';
   ```
5. **ุฌุฑุจ ุชุบููุฑ ุงูุฏูุฑ**
6. **ุฌุฑุจ ุงูุญุธุฑ**
7. **ุฌุฑุจ ุงูููุงุชุฑ**

---

## ๐ ุงูุชูู!

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐
