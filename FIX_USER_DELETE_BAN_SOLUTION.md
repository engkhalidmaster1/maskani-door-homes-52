# ๐ง ุฅุตูุงุญ ูุดููุฉ ุญุฐู ูุญุธุฑ ุงููุณุชุฎุฏููู
## Fix User Delete and Ban Issues

**ุงูุชุงุฑูุฎ**: 15 ุฃูุชูุจุฑ 2025  
**ุงููุดููุฉ**: ุนุฏู ุงููุฏุฑุฉ ุนูู ุญุฐู ุฃู ุญุธุฑ ุงููุณุชุฎุฏู `klidmorre@gmail.com`

---

## ๐ ุงููุดุงูู ุงูููุชุดูุฉ

### 1๏ธโฃ ูุดููุฉ ุงูุญุฐู

**ุงูุณุจุจ**:
- ุงูููุฏ ูู `useDashboardData.tsx` ูุงู ูุญุงูู ุญุฐู ุงููุณุชุฎุฏู ูู `profiles` ู `user_roles` ููุท
- **ูุง ูููู** ุญุฐู ุงููุณุชุฎุฏู ูู `auth.users` ุจุงุณุชุฎุฏุงู ููุชุงุญ ุงูุนููู (anon key)
- ูุชุทูุจ ุงุณุชุฎุฏุงู Service Role Key ุนุจุฑ Edge Function

**ุงูููุฏ ุงููุฏูู (ุงููุนุทู)**:
```typescript
const deleteUser = async (userId: string) => {
  // ุญุฐู ุงูุนูุงุฑุงุช
  await supabase.from('properties').delete().eq('user_id', userId);
  
  // ุญุฐู ุงูููู ุงูุดุฎุตู
  await supabase.from('profiles').delete().eq('user_id', userId);
  
  // ุญุฐู ุงูุฏูุฑ
  await supabase.from('user_roles').delete().eq('user_id', userId);
  
  // โ๏ธ ุงููุณุชุฎุฏู ูุจูู ูู auth.users!
}
```

**ุงูููุฏ ุงูุฌุฏูุฏ (ูุนูู)**:
```typescript
const deleteUser = async (userId: string) => {
  if (!isAdmin) return;

  // ุงุณุชุฎุฏุงู Edge Function ููุญุฐู ุงููุงูู
  const { error } = await supabase.functions.invoke('admin-delete-user', {
    body: { userId }
  });

  if (error) throw error;

  // ุชุญุฏูุซ ุงูุจูุงูุงุช
  await Promise.all([fetchUsers(), fetchUserProperties()]);
  
  toast({
    title: "ุชู ุญุฐู ุงููุณุชุฎุฏู",
    description: "ุชู ุญุฐู ุงููุณุชุฎุฏู ูุฌููุน ุนูุงุฑุงุชู ุจูุฌุงุญ ูู ุงููุธุงู ุจุงููุงูู"
  });
}
```

---

### 2๏ธโฃ ูุดููุฉ ุงูุญุธุฑ ูู ุงููุดุฑ

**ุงูุณุจุจ**:
- ุณูุงุณุงุช RLS (Row Level Security) ุนูู ุฌุฏูู `properties` ุชููุน ุงููุฏูุฑ ูู ุชุญุฏูุซ ุนูุงุฑุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู
- ุงูููุฏ ูุญุงูู ุชุญุฏูุซ `is_published = false` ููู RLS ูุฑูุถ ุงูุนูููุฉ

**ุงูููุฏ ุงูููุฌูุฏ**:
```typescript
const banUserFromPublishing = async (userId: string) => {
  // ุชุญุฏูุซ ุฌููุน ุนูุงุฑุงุช ุงููุณุชุฎุฏู
  const { error } = await supabase
    .from('properties')
    .update({ is_published: false })
    .eq('user_id', userId);
    
  // โ๏ธ RLS ูููุน ูุฐุง ุฅุฐุง ูู ููู ุงููุฏูุฑ ูุตุฑุญุงู
}
```

**ุงูุญู**: ุชุญุฏูุซ RLS policies ูู Supabase

---

## โ ุงูุญููู ุงููุทุจูุฉ

### 1๏ธโฃ ุชุญุฏูุซ `useDashboardData.tsx`

โ **ุชู ุงูุชุนุฏูู**: ุงุณุชุฎุฏุงู Edge Function `admin-delete-user` ููุญุฐู ุงููุงูู

**ุงูููู**: `src/hooks/useDashboardData.tsx`  
**ุงูุณุทูุฑ**: 147-172

**ุงูุชุบููุฑ**:
- ุงุณุชุจุฏุงู ุงูุญุฐู ุงููุจุงุดุฑ ูู ุงูุฌุฏุงูู
- ุงุณุชุฎุฏุงู `supabase.functions.invoke('admin-delete-user')`
- ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู

---

### 2๏ธโฃ ุฅูุดุงุก ููู SQL ูุชุญุฏูุซ RLS

โ **ุชู ุงูุฅูุดุงุก**: `FIX_PROPERTIES_RLS_FOR_ADMINS.sql`

**ุงููุญุชูู**:
- ุญุฐู ุงูุณูุงุณุงุช ุงููุฏููุฉ
- ุฅูุดุงุก ุณูุงุณุงุช ุฌุฏูุฏุฉ ุชุณูุญ ูููุฏูุฑูู ุจุงูุชุญูู ุงููุงูู
- ุณูุงุณุงุช ูููุตูุฉ ูููุฑุงุกุฉ ูุงูุฅุถุงูุฉ ูุงูุชุญุฏูุซ ูุงูุญุฐู

**ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ**:

1. **ุงููุฑุงุกุฉ** (`public_read_published_properties`):
   - ุงูุฌููุน: ุงูุนูุงุฑุงุช ุงูููุดูุฑุฉ ููุท
   - ุงููุงูู: ุฌููุน ุนูุงุฑุงุชู
   - ุงููุฏูุฑ: ุฌููุน ุงูุนูุงุฑุงุช

2. **ุงูุฅุถุงูุฉ** (`users_insert_properties`):
   - ุงููุณุชุฎุฏููู: ุนูุงุฑุงุชูู ููุท
   - ุงููุฏูุฑ: ุฃู ุนูุงุฑ

3. **ุงูุชุญุฏูุซ** (`users_and_admins_update_properties`):
   - ุงููุณุชุฎุฏููู: ุนูุงุฑุงุชูู ููุท
   - ุงููุฏูุฑ: ุฌููุน ุงูุนูุงุฑุงุช (ุจูุง ูู ุฐูู `is_published`)

4. **ุงูุญุฐู** (`users_and_admins_delete_properties`):
   - ุงููุณุชุฎุฏููู: ุนูุงุฑุงุชูู ููุท
   - ุงููุฏูุฑ: ุฌููุน ุงูุนูุงุฑุงุช

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ ุงูููุฏ (โ ุชู)
- ุชู ุชุญุฏูุซ `src/hooks/useDashboardData.tsx`

### ุงูุฎุทูุฉ 2: ุชุทุจูู RLS ูู Supabase

1. ุงูุชุญ Supabase Dashboard
2. ุงูุชูู ุฅูู **SQL Editor**
3. ุงูุณุฎ ูุญุชูู ููู `FIX_PROPERTIES_RLS_FOR_ADMINS.sql`
4. ุงูุตู ูู ุงููุญุฑุฑ
5. ุงุถุบุท **Run** ุฃู **Execute**

ุฃู ุงุณุชุฎุฏู ุงูุฃูุฑ ูู Terminal:

```bash
# ูู ูุฌูุฏ ุงููุดุฑูุน
supabase db push

# ุฃู
npx supabase db push
```

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงูุญู

1. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ ุจุงูุถุบุท ุนูู `Ctrl+Shift+R`
2. ุงูุชูู ุฅูู Dashboard โ Users
3. ุฌุฑุจ ุญุฐู ุงููุณุชุฎุฏู `klidmorre@gmail.com`
4. ุฌุฑุจ ุญุธุฑ ุงููุณุชุฎุฏู ูู ุงููุดุฑ
5. ุชุญูู ูู ุฑุณุงุฆู ุงููุฌุงุญ/ุงูุฎุทุฃ

---

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

### ุงุฎุชุจุงุฑ ุงูุญุฐู:
```typescript
// ูู Console ุงููุชุตูุญ
// ุงูุชุธุฑ ุฑุณุงูุฉ: "ุชู ุญุฐู ุงููุณุชุฎุฏู ูุฌููุน ุนูุงุฑุงุชู ุจูุฌุงุญ ูู ุงููุธุงู ุจุงููุงูู"
```

### ุงุฎุชุจุงุฑ ุงูุญุธุฑ:
```typescript
// ูู Console ุงููุชุตูุญ
// ุงูุชุธุฑ ุฑุณุงูุฉ: "ุชู ุญุธุฑ ุงููุณุชุฎุฏู ูู ุงููุดุฑ"
// ุชุญูู ูู is_published = false ูุฌููุน ุนูุงุฑุงุช ุงููุณุชุฎุฏู
```

### ุงูุชุญูู ูู RLS ูู Supabase:

```sql
-- ุชุดุบูู ูู SQL Editor
SELECT 
  policyname,
  cmd,
  permissive
FROM pg_policies
WHERE tablename = 'properties'
ORDER BY policyname;

-- ูุฌุจ ุฃู ุชุฑู 4 ุณูุงุณุงุช:
-- 1. public_read_published_properties (SELECT)
-- 2. users_insert_properties (INSERT)
-- 3. users_and_admins_update_properties (UPDATE)
-- 4. users_and_admins_delete_properties (DELETE)
```

---

## ๐จ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ 1: "failed to send request to edge function"

**ุงูุณุจุจ**: Service Worker ูุนุชุฑุถ ุงูุทูุจ

**ุงูุญู**:
```javascript
// ุชุญูู ูู public/service-worker.js
// ูุฌุจ ุฃู ูุญุชูู ุนูู:
if (url.pathname.startsWith('/functions/v1/')) {
  return fetch(event.request);
}
```

---

### ุฎุทุฃ 2: "Failed to delete user"

**ุงูุณุจุจ**: Edge Function ุบูุฑ ููุดูุฑุฉ ุฃู CORS ุฎุงุทุฆ

**ุงูุญู**:
1. ุชุญูู ูู ูุดุฑ Edge Functions:
   ```bash
   supabase functions list
   ```

2. ุชุญูู ูู CORS ูู `admin-delete-user/index.ts`:
   ```typescript
   const corsHeaders = {
     'Access-Control-Allow-Origin': '*',
     'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, x-supabase-authorization, accept',
     'Access-Control-Max-Age': '86400',
   };
   ```

---

### ุฎุทุฃ 3: "RLS policy violation"

**ุงูุณุจุจ**: ูู ูุชู ุชุทุจูู ููู SQL

**ุงูุญู**:
1. ููุฐ `FIX_PROPERTIES_RLS_FOR_ADMINS.sql` ูู Supabase
2. ุชุญูู ูู ุชุทุจูู ุงูุณูุงุณุงุช:
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'properties';
   ```

---

## ๐ ุงููุฑู ุจูู ุงููุฏูู ูุงูุฌุฏูุฏ

| ุงูููุฒุฉ | ุงููุฏูู โ | ุงูุฌุฏูุฏ โ |
|--------|----------|----------|
| **ุญุฐู ุงููุณุชุฎุฏู** | ูู profiles ููุท | ูู auth.users ุจุงููุงูู |
| **ุงุณุชุฎุฏุงู Edge Function** | ูุง | ูุนู |
| **Service Role Key** | ูุง | ูุนู |
| **ุญุฐู ููุงุฆู** | ูุง (ูุจูู ูู auth) | ูุนู |
| **ุญุธุฑ ูู ุงููุดุฑ** | ููุดู (RLS) | ูุนูู |
| **ุชุญุฏูุซ is_published** | ููููุน | ูุณููุญ ูููุฏูุฑ |
| **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** | ุจุณูุทุฉ | ุดุงููุฉ |

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅุตูุงุญู:

โ **ุงูุญุฐู**: ูุนูู ุงูุขู ุจุดูู ูุงูู ุนุจุฑ Edge Function  
โ **ุงูุญุธุฑ**: ุณูุนูู ุจุนุฏ ุชุทุจูู RLS ูู Supabase  
โ **ุงูุฃูุงู**: ุงุณุชุฎุฏุงู Service Role Key ููุนูููุงุช ุงูุญุณุงุณุฉ  
โ **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**: ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู

### ูุง ูุฌุจ ุนููู ูุนูู:

1. โ ุชู ุชุญุฏูุซ ุงูููุฏ ุชููุงุฆูุงู
2. โณ **ููุฐ ููู SQL** ูู Supabase Dashboard
3. โณ ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ
4. โณ ุงุฎุชุจุฑ ุงูุญุฐู ูุงูุญุธุฑ

---

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:
1. ุชุญูู ูู Console ุงููุชุตูุญ (F12)
2. ุชุญูู ูู Supabase Logs
3. ุชุฃูุฏ ูู ุตูุงุญูุงุช ุงููุฏูุฑ ูู `user_roles`
4. ุฑุงุฌุน ูุฐุง ุงูููู ููุญููู

---

**ุขุฎุฑ ุชุญุฏูุซ**: 15 ุฃูุชูุจุฑ 2025  
**ุงูุญุงูุฉ**: โ ุงูุญู ุฌุงูุฒ - ูุญุชุงุฌ ุชุทุจูู SQL ูู Supabase
