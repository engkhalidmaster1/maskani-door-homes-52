# 🔄 تحديث حالة الصفقة التلقائي عند تغيير نوع العرض

## ✅ التحديث المُنفذ

تم تحديث صفحة تعديل العقار (`EditProperty.tsx`) لتغيير **حالة الصفقة (Status)** تلقائياً عند تغيير **نوع العرض (listing_type)** لضمان التوافق المنطقي.

---

## 🎯 المشكلة الأصلية

عند تغيير نوع العرض من **بيع** إلى **إيجار** أو العكس، كانت حالة الصفقة تبقى كما هي، مما يؤدي إلى:

- ❌ عقار للإيجار بحالة "تم البيع" (غير منطقي)
- ❌ عقار للبيع بحالة "تم الإيجار" (غير منطقي)

---

## ✨ الحل المُطبق

### القواعد الجديدة:

#### 1️⃣ **عند التغيير من إيجار → بيع:**
```typescript
إذا كانت الحالة = "تم الإيجار" → تتغير تلقائياً إلى "متاح"
إذا كانت الحالة = "تم البيع" → تبقى "تم البيع"
إذا كانت الحالة = "متاح" → تبقى "متاح"
```

**السبب:** لأن "تم الإيجار" غير منطقي مع عقار للبيع

#### 2️⃣ **عند التغيير من بيع → إيجار:**
```typescript
إذا كانت الحالة = "تم البيع" → تتغير تلقائياً إلى "متاح"
إذا كانت الحالة = "تم الإيجار" → تبقى "تم الإيجار"
إذا كانت الحالة = "متاح" → تبقى "متاح"
```

**السبب:** لأن "تم البيع" غير منطقي مع عقار للإيجار

---

## 📊 أمثلة السيناريوهات

### ✅ السيناريو 1: تغيير من بيع إلى إيجار
```
الحالة قبل: نوع العرض = بيع | الحالة = تم البيع
المستخدم: يضغط زر "للإيجار"
النتيجة: نوع العرض = إيجار | الحالة = متاح ✅
```

### ✅ السيناريو 2: تغيير من إيجار إلى بيع
```
الحالة قبل: نوع العرض = إيجار | الحالة = تم الإيجار
المستخدم: يضغط زر "للبيع"
النتيجة: نوع العرض = بيع | الحالة = متاح ✅
```

### ✅ السيناريو 3: الحالة متاح
```
الحالة قبل: نوع العرض = بيع | الحالة = متاح
المستخدم: يضغط زر "للإيجار"
النتيجة: نوع العرض = إيجار | الحالة = متاح ✅
```

### ✅ السيناريو 4: الحفاظ على الحالة المتوافقة
```
الحالة قبل: نوع العرض = بيع | الحالة = تم البيع
المستخدم: يضغط زر "للبيع" مرة أخرى (بدون تغيير)
النتيجة: نوع العرض = بيع | الحالة = تم البيع ✅
```

---

## 🔧 الكود المُطبق

### قبل التعديل:
```tsx
// زر "للبيع" - لا يغير الحالة
<Button 
  onClick={() => setProperty(prev => ({ ...prev, listing_type: "sale" }))}
>
  💰 للبيع
</Button>

// زر "للإيجار" - لا يغير الحالة
<Button 
  onClick={() => setProperty(prev => ({ ...prev, listing_type: "rent" }))}
>
  🏠 للإيجار
</Button>
```

### بعد التعديل:
```tsx
// زر "للبيع" - يغير الحالة إذا كانت "تم الإيجار"
<Button 
  onClick={() => setProperty(prev => ({ 
    ...prev, 
    listing_type: "sale",
    status: prev.status === "rented" ? "available" 
            : prev.status === "sold" ? "sold" 
            : "available"
  }))}
>
  💰 للبيع
</Button>

// زر "للإيجار" - يغير الحالة إذا كانت "تم البيع"
<Button 
  onClick={() => setProperty(prev => ({ 
    ...prev, 
    listing_type: "rent",
    status: prev.status === "sold" ? "available" 
            : prev.status === "rented" ? "rented" 
            : "available"
  }))}
>
  🏠 للإيجار
</Button>
```

---

## 📋 جدول التحولات

| نوع العرض القديم | الحالة القديمة | نوع العرض الجديد | الحالة الجديدة | السبب |
|------------------|----------------|------------------|----------------|-------|
| بيع | تم البيع | إيجار | متاح | "تم البيع" غير منطقي مع الإيجار |
| بيع | متاح | إيجار | متاح | لا تغيير (متوافق) |
| إيجار | تم الإيجار | بيع | متاح | "تم الإيجار" غير منطقي مع البيع |
| إيجار | متاح | بيع | متاح | لا تغيير (متوافق) |
| بيع | تم البيع | بيع | تم البيع | لا تغيير (نفس النوع) |
| إيجار | تم الإيجار | إيجار | تم الإيجار | لا تغيير (نفس النوع) |

---

## 🧪 كيفية الاختبار

### الاختبار 1: بيع → إيجار
```bash
1. افتح صفحة تعديل عقار: /properties/[id]/edit
2. تأكد أن نوع العرض = "بيع"
3. اضبط الحالة على "تم البيع" (الزر الأحمر)
4. اضغط على زر "للإيجار"
5. ✅ تحقق: الحالة يجب أن تصبح "متاح" تلقائياً
6. ✅ يجب أن يظهر زر "تم الإيجار" (أخضر) بدلاً من "تم البيع"
```

### الاختبار 2: إيجار → بيع
```bash
1. افتح صفحة تعديل عقار: /properties/[id]/edit
2. تأكد أن نوع العرض = "إيجار"
3. اضبط الحالة على "تم الإيجار" (الزر الأخضر)
4. اضغط على زر "للبيع"
5. ✅ تحقق: الحالة يجب أن تصبح "متاح" تلقائياً
6. ✅ يجب أن يظهر زر "تم البيع" (أحمر) بدلاً من "تم الإيجار"
```

### الاختبار 3: الحالة متاح
```bash
1. افتح صفحة تعديل عقار
2. اضبط الحالة على "متاح"
3. غيّر نوع العرض من بيع إلى إيجار أو العكس
4. ✅ تحقق: الحالة تبقى "متاح"
```

---

## 🎨 التجربة البصرية

### زر "للبيع":
- نوع العرض يتغير إلى **بيع**
- إذا كانت الحالة "تم الإيجار" → تتغير تلقائياً
- زر "تم البيع" (أحمر 🔴) يظهر بدلاً من "تم الإيجار"

### زر "للإيجار":
- نوع العرض يتغير إلى **إيجار**
- إذا كانت الحالة "تم البيع" → تتغير تلقائياً
- زر "تم الإيجار" (أخضر 🟢) يظهر بدلاً من "تم البيع"

---

## 💡 المنطق التقني

### الشرط المستخدم:

```typescript
// عند اختيار "بيع"
status: prev.status === "rented" ? "available"      // إذا كانت "تم الإيجار" → غيّرها
        : prev.status === "sold" ? "sold"           // إذا كانت "تم البيع" → احتفظ بها
        : "available"                               // أي حالة أخرى → اجعلها "متاح"

// عند اختيار "إيجار"
status: prev.status === "sold" ? "available"        // إذا كانت "تم البيع" → غيّرها
        : prev.status === "rented" ? "rented"       // إذا كانت "تم الإيجار" → احتفظ بها
        : "available"                               // أي حالة أخرى → اجعلها "متاح"
```

---

## ✅ فوائد التحديث

1. ✅ **منطقية أفضل**: لا يمكن أن يكون عقار للبيع بحالة "تم الإيجار"
2. ✅ **تجربة مستخدم محسّنة**: لا حاجة لتغيير الحالة يدوياً
3. ✅ **منع الأخطاء**: يمنع حفظ بيانات غير متسقة
4. ✅ **واجهة أذكى**: الأزرار تتغير تلقائياً حسب نوع العرض
5. ✅ **توفير الوقت**: خطوة واحدة بدلاً من خطوتين

---

## 🔍 ملاحظات إضافية

### الحالات المدعومة:
- ✅ **متاح** (available) - يعمل مع بيع وإيجار
- ✅ **تم البيع** (sold) - فقط مع عقارات البيع
- ✅ **تم الإيجار** (rented) - فقط مع عقارات الإيجار

### الأذونات:
- قسم "حالة الصفقة" يظهر فقط لـ:
  - ✅ صاحب العقار (Owner)
  - ✅ المدير (Admin)

### التأثير على قاعدة البيانات:
- عند الحفظ، سيتم حفظ `listing_type` و `status` الجديدين معاً
- لا يوجد تأثير على العقارات الموجودة حتى يتم تعديلها

---

## 🐛 حل المشاكل

### ❌ المشكلة: الحالة لا تتغير
**الحل:**
1. تأكد من أنك ضغطت على زر نوع العرض (للبيع/للإيجار)
2. أعد تحميل الصفحة
3. تحقق من Console (F12) لأي أخطاء

### ❌ المشكلة: لا أرى قسم "حالة الصفقة"
**الحل:**
- هذا القسم يظهر فقط لصاحب العقار أو المدير
- تأكد من تسجيل دخولك كصاحب العقار

### ❌ المشكلة: الزر الخطأ يظهر (أحمر بدلاً من أخضر)
**الحل:**
- هذا سلوك صحيح! الزر يتغير حسب نوع العرض:
  - بيع → زر أحمر "تم البيع"
  - إيجار → زر أخضر "تم الإيجار"

---

## 📊 إحصائيات التحديث

- **الملفات المُعدلة:** 1 (`EditProperty.tsx`)
- **الأسطر المُعدلة:** ~30 سطر
- **الأخطاء:** 0
- **الحالة:** ✅ جاهز للاستخدام
- **التأثير:** صفحة تعديل العقار فقط

---

## 🎯 الخلاصة

**قبل:** عند تغيير نوع العرض، الحالة تبقى كما هي (قد تكون غير منطقية) ❌  
**بعد:** عند تغيير نوع العرض، الحالة تتغير تلقائياً لتكون متوافقة ✅

**النتيجة:** تجربة مستخدم أفضل وبيانات أكثر اتساقاً! 🎉

---

**تاريخ التحديث:** 14 أكتوبر 2025  
**الحالة:** ✅ مُنفذ ومُختبر  
**الملف:** `src/pages/EditProperty.tsx`
