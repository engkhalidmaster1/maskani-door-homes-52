# 🎯 دليل نظام صلاحيات المستخدمين الجديد

## 📋 نظرة عامة

تم إنشاء نظام صلاحيات متطور يضم ثلاث حالات مختلفة للمستخدمين مع قيود محددة لكل حالة.

## 🏗️ الحالات الثلاث

### 1. ناشر (Publisher) - الحالة الافتراضية
- **الوصف**: مستخدم عادي يمكنه نشر عقار واحد فقط
- **حد العقارات**: 1 عقار
- **حد الصور**: صورتان لكل عقار
- **الأيقونة**: 👤
- **اللون**: رمادي

### 2. مالك موثوق (Trusted Owner)
- **الوصف**: مالك موثوق يمكنه نشر عدة عقارات
- **حد العقارات**: 5 عقارات
- **حد الصور**: 5 صور لكل عقار
- **الأيقونة**: 🛡️
- **اللون**: أخضر

### 3. مكلف بالنشر (Office Agent)
- **الوصف**: صاحب مكتب دلالية أو مكلف بالنشر
- **حد العقارات**: غير محدود (999)
- **حد الصور**: 7 صور لكل عقار
- **الأيقونة**: 🏢
- **اللون**: أزرق

## ⚙️ المكونات المطلوبة

### 1. Migration قاعدة البيانات
```sql
-- ملف: supabase/migrations/20250104000000_create_user_statuses.sql
-- يحتوي على:
- إنشاء enum للحالات الثلاث
- جدول user_statuses مع الحدود والصلاحيات
- RLS policies للأمان
- دوال مساعدة للتحديث والاستعلام
- Trigger تلقائي لإنشاء حالة افتراضية للمستخدمين الجدد
```

### 2. TypeScript Types
```typescript
// ملف: src/integrations/supabase/types.ts
- إضافة user_status enum
- إضافة جدول user_statuses
- تحديث Constants
```

### 3. Hook إدارة الحالات
```typescript
// ملف: src/hooks/useUserStatus.tsx
- إدارة حالات المستخدمين
- دوال التحديث والاستعلام
- التحقق من الحدود
```

### 4. مكون تحكم الأدمن
```typescript
// ملف: src/components/Dashboard/UserStatusControl.tsx
- dropdown لتغيير حالة المستخدم
- عرض الحدود والوصف
- تأكيد التغييرات
```

## 🎨 التحديثات على الواجهة

### 1. الداشبورد الإداري
- **جدول المستخدمين**: إضافة عمود "حالة المستخدم" مع dropdown للتحكم
- **عمود الحدود**: عرض حدود العقارات والصور لكل مستخدم
- **عداد العقارات**: عرض العدد الحالي/الحد الأقصى

### 2. صفحة إضافة العقار
- **كارت معلومات الحساب**: عرض حالة المستخدم والحدود
- **عداد الصور**: عرض الصور المختارة/الحد الأقصى
- **قيود التحميل**: منع تجاوز حد الصور
- **منع النشر**: إيقاف الزر عند تجاوز حد العقارات

### 3. الهيدر
- **badge حالة المستخدم**: عرض الحالة الحالية بجانب اسم المستخدم
- **أيقونات مختلفة**: لكل حالة أيقونة مميزة
- **ألوان مختلفة**: تمييز بصري لكل حالة

## 🔧 كيفية التطبيق

### الخطوة 1: تشغيل Migration
```bash
# في مجلد supabase
npx supabase db reset
# أو إذا كان Supabase يعمل
npx supabase db push
```

### الخطوة 2: التحقق من البيانات
```sql
-- التحقق من إنشاء الجدول
SELECT * FROM user_statuses LIMIT 5;

-- التحقق من الدوال
SELECT * FROM pg_proc WHERE proname LIKE '%user_status%';
```

### الخطوة 3: اختبار الوظائف
1. **تسجيل مستخدم جديد** - يجب أن يحصل على حالة "ناشر" تلقائياً
2. **تغيير الحالة من الداشبورد** - اختبار أزرار التحكم
3. **اختبار القيود** - محاولة تجاوز حدود العقارات والصور

## 🎯 الميزات الجديدة

### للمديرين
- **تحكم كامل** في حالات المستخدمين
- **عرض شامل** للحدود والاستخدام
- **تتبع دقيق** لنشاط المستخدمين

### للمستخدمين
- **وضوح تام** في الحدود المسموحة
- **تجربة محسنة** مع عرض الحالة
- **منع الأخطاء** قبل وقوعها

### للنظام
- **أمان معزز** مع RLS policies
- **مرونة في التطوير** مع إمكانية إضافة حالات جديدة
- **سجلات مفصلة** للتحديثات والتغييرات

## 🚀 المرحلة التالية

بعد تطبيق هذا النظام يمكن إضافة:

1. **إشعارات تلقائية** عند اقتراب المستخدم من الحدود
2. **تقارير تفصيلية** لاستخدام المستخدمين
3. **نظام طلبات ترقية** الحساب
4. **حدود زمنية** للنشر (يومية/شهرية)
5. **نظام نقاط ومكافآت** للمستخدمين النشطين

## 📞 ملاحظات مهمة

⚠️ **تحديث قاعدة البيانات مطلوب**: يجب تطبيق migration قبل استخدام النظام
⚠️ **اختبار شامل**: تأكد من اختبار جميع الحالات قبل الإنتاج  
⚠️ **نسخ احتياطي**: احتفظ بنسخة احتياطية قبل تطبيق التحديثات

النظام الآن جاهز للاستخدام! 🎉








